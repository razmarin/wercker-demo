# docker box definition
box:
  id: openjdk
  ports:
    - "8080"

# Build definition
build:
  steps:
    - script:
        name: make gradlew executable
        code: chmod +x gradlew
    - script:
        name: gradle build
        code: |
          ./gradlew --full-stacktrace -q --project-cache-dir=$WERCKER_CACHE_DIR build assemble
  after-steps:
    - install-packages:
        packages: ruby
    - wantedly/pretty-slack-notify:
        webhook_url: $SLACK_URL

run-tests:
  steps:
    - script:
        name: make gradlew executable
        code: chmod +x gradlew
    - script:
        name: "run unit tests"
        code: |
          ./gradlew --project-cache-dir=$WERCKER_CACHE_DIR clean test
  after-steps:
    - install-packages:
        packages: ruby
    - wantedly/pretty-slack-notify:
        webhook_url: $SLACK_URL
deploy:
  box: openjdk
  steps:
    - script:
      name: "Copy artefact to app"
      code: |
        mkdir /app
        cp $WERCKER_ROOT/build/libs/hello-*.jar /app/app.jar
    - internal/docker-push:
        username: $USERNAME
        password: $PASSWORD
        tag: $WERCKER_GIT_BRANCH
        repository: razvanmarin/test-site
        registry: https://registry.hub.docker.com/v2
        cmd: "/bin/sh -c \"cd /app && java -jar app.jar \""
  after-steps:
    - install-packages:
        packages: ruby
    - wantedly/pretty-slack-notify:
        webhook_url: $SLACK_URL